<div class="card">
  <h2 class="card__title">Gerenciar Disciplinas</h2>

  <div class="card__content">
    <div class="table-responsive">
      <table class="product-table">
        <thead>
          <tr>
            <th>Disciplina</th>
            <th>Questões</th>
            <th>Professores</th>
            <th class="acoes">Ações</th>
          </tr>
        </thead>

        <tbody>

          <!-- LOADING -->
          @if(!currentUser){
            <tr>
              <td colspan="4">
                <div class="loading-spinner"></div>
              </td>
            </tr>
          }

          <!-- LISTAGEM -->
          @if(currentUser && disciplinas && disciplinas.length > 0) {
            @for(disciplina of disciplinasPaginadas; track disciplina.id) {

              <tr>
                <td>
                  @if(editandoId() !== disciplina.id) {
                    <span>{{ disciplina.nome }}</span>
                  } @else {
                    <!-- MODO EDIÇÃO -->
                    <div class="edit-wrapper" style="display: flex; flex-direction: column;">

                      <div class="edit-container">
                        <!-- AQUI: Usamos apenas [appDisciplinaUnica] -->
                        <input
                          type="text"
                          [ngModel]="nomeEditando()"
                          (ngModelChange)="nomeEditando.set($event)"
                          (keydown.enter)="!editInput.invalid ? confirmarEdicaoClick(disciplina.id) : null"
                          (keydown.escape)="cancelarEdicaoClick()"
                          autoFocus
                          required
                          #editInput="ngModel"
                          [appDisciplinaUnica]="disciplina.id"
                        />

                        <button
                          mat-icon-button
                          class="btn-success"
                          [disabled]="editInput.invalid"
                          (click)="confirmarEdicaoClick(disciplina.id)">
                          <mat-icon>check</mat-icon>
                        </button>

                        <button
                          mat-icon-button
                          color="warn"
                          (click)="cancelarEdicaoClick()">
                          <mat-icon>close</mat-icon>
                        </button>
                      </div>

                      @if(editInput.errors?.['disciplinaExistente']) {
                        <small style="color: red; margin-top: 5px;">Nome já existe.</small>
                      }
                      @if(editInput.errors?.['required'] && (editInput.dirty || editInput.touched)) {
                        <small style="color: red; margin-top: 5px;">Nome obrigatório.</small>
                      }

                    </div>
                  }
                </td>

                <td>{{ quantidadeQuestoes(disciplina) }}</td>
                <td>{{ quantidadeMaterias(disciplina) }}</td>

                <td class="col-acoes">
                  <div class="actions-flex">
                    <button
                      mat-icon-button
                      color="primary"
                      (click)="entrarEdicao(disciplina)"
                      matTooltip="Editar Disciplina">
                      <mat-icon>edit</mat-icon>
                    </button>

                    <button
                      mat-icon-button
                      color="warn"
                      (click)="excluir.emit(disciplina.id)"
                      matTooltip="Excluir Disciplina">
                      <mat-icon>delete</mat-icon>
                    </button>
                  </div>
                </td>
              </tr>

            }
          }

          <!-- NENHUMA DISCIPLINA -->
          @if(currentUser && (!disciplinas || disciplinas.length === 0)){
            <tr>
              <td colspan="4" class="text-center">Nenhuma disciplina cadastrada.</td>
            </tr>
          }

          <!-- CRIAÇÃO -->
          @if(criando()){
            <tr class="criacao-row">
              <td colspan="4">
                <div class="novo-wrapper" style="display: flex; flex-direction: column;">

                  <div class="novo-container">
                    <!-- AQUI: Passamos null explicitamente na propriedade -->
                    <input
                      type="text"
                      placeholder="Nome da nova disciplina"
                      [ngModel]="nomeCriando()"
                      (ngModelChange)="nomeCriando.set($event)"
                      (keydown.enter)="!createInput.invalid ? confirmarCriacao() : null"
                      (keydown.escape)="cancelarCriacao()"
                      autoFocus
                      required
                      #createInput="ngModel"
                      [appDisciplinaUnica]="null"
                    />

                    <button
                      mat-icon-button
                      class="btn-success"
                      [disabled]="createInput.invalid"
                      (click)="confirmarCriacao()">
                      <mat-icon>check</mat-icon>
                    </button>

                    <button
                      mat-icon-button
                      color="warn"
                      (click)="cancelarCriacao()">
                      <mat-icon>close</mat-icon>
                    </button>
                  </div>

                  @if(createInput.errors?.['disciplinaExistente']) {
                    <small style="color: red; margin-top: 5px; margin-left: 10px;">Disciplina já cadastrada.</small>
                  }
                  @if(createInput.errors?.['required'] && (createInput.dirty || createInput.touched)) {
                    <small style="color: red; margin-top: 5px; margin-left: 10px;">Nome obrigatório.</small>
                  }

                </div>
              </td>
            </tr>
          }

        </tbody>
      </table>
    </div>

    <mat-paginator
      [length]="length"
      [pageSize]="pageSize"
      [pageIndex]="pageIndex"
      [pageSizeOptions]="[5, 10, 25, 50]"
      (page)="trocarPagina($event)">
    </mat-paginator>

    <div class="footer-actions">
      <button
        mat-raised-button
        color="primary"
        class="novo-btn"
        (click)="iniciarCriacao()">
        <mat-icon>add</mat-icon>
        Nova Disciplina
      </button>
    </div>

  </div>
</div>
