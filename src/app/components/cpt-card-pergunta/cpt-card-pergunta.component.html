<mat-card
  class="card-pergunta"
  [class.selected]="isSelected"
  [class.disabled]="isDisabled && !isSelected">

  <div class="cabecalho" (click)="toggleExpand()">

    <div *ngIf="isSelectionMode" class="selection-control" (click)="$event.stopPropagation()">
      <input
        type="checkbox"
        class="custom-checkbox"
        [checked]="isSelected"
        [disabled]="isDisabled && !isSelected"
        (change)="onSelectToggle()"
      />
    </div>

    <div class="titulo-container">
      <div class="enunciado-row">
        <h3 class="titulo">{{ pergunta.enunciado }}</h3>

        <div 
          *ngIf="pergunta.imagem" 
          class="icone-imagem-badge" 
          matTooltip="Visualizar imagem"
          (click)="verImagem($event, imageDialog)">
          <mat-icon>image</mat-icon>
        </div>
      </div>

      <span class="prof-label">Prof. {{ pergunta.professorId | nomeProfessor: professores }}</span>
    </div>

    <mat-icon class="icone-expand" [class.rotated]="expanded">expand_more</mat-icon>
  </div>

  <div class="conteudo-expandido" *ngIf="expanded">

    <div *ngIf="isSelectionMode" class="modo-leitura">
      <p class="label-alternativas">Alternativas:</p>
      <ul class="lista-alternativas-readonly">
        <li *ngFor="let alt of pergunta.alternativas; let i = index">
          <span class="letra">{{ getLetra(i) }}</span> {{ alt.texto }}
        </li>
      </ul>
      <div *ngIf="!pergunta.alternativas.length" class="aviso-vazio">Sem alternativas cadastradas.</div>
    </div>

    <div *ngIf="!isSelectionMode" class="modo-edicao">
      <div class="alternativas-editaveis">
        <app-cpt-alternativa-forms
          *ngFor="let alt of pergunta.alternativas; let i = index"
          [alternativa]="alt"
          [index]="i"
          (textoChange)="onAlterarTexto($event)"
        ></app-cpt-alternativa-forms>
      </div>

      <div class="footer-actions">
        <button
          mat-button
          color="primary"
          (click)="onEdit(); $event.stopPropagation()"
        >
          <mat-icon>edit</mat-icon> Editar
        </button>

        <button
          *ngIf="isCoordenador"
          mat-button
          color="warn"
          (click)="onDelete(); $event.stopPropagation()"
        >
          <mat-icon>delete</mat-icon> Excluir
        </button>
      </div>
    </div>
  </div>
</mat-card>

<ng-template #imageDialog>
  <div style="padding: 20px; text-align: center; position: relative;">
    <h3 style="margin-top: 0; color: #333;">Imagem da Quest√£o</h3>
    <img [src]="pergunta.imagem" style="max-width: 100%; max-height: 80vh; border-radius: 8px;">
    <div style="margin-top: 20px;">
      <button mat-raised-button color="primary" [mat-dialog-close]="true">Fechar</button>
    </div>
  </div>
</ng-template>