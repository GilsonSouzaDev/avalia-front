<div class="form-container">
  <h1 class="form-title">{{ titulo }}</h1>

  <form #questionForm="ngForm" (ngSubmit)="onSubmit(questionForm)" class="question-form">
    <div class="card">
      
      <div class="header-group">
        <div class="form-group disciplina-group">
          <label for="disciplina">Disciplina</label>

          <ng-container *ngIf="!isEdicao">
            <select
              id="disciplina"
              name="disciplina"
              [(ngModel)]="disciplinaId"
              required
              class="form-control"
            >
              <option [ngValue]="null" disabled>Selecione a Disciplina</option>
              <option
                *ngFor="let disciplina of disciplinas"
                [ngValue]="disciplina.id"
              >
                {{ disciplina.nome }}
              </option>
            </select>
          </ng-container>

          <ng-container *ngIf="isEdicao">
            <input
              type="text"
              class="form-control"
              [value]="perguntaParaEdicao?.disciplina?.nome || 'Disciplina Indefinida'"
              disabled
              readonly
              style="background-color: #e9ecef; cursor: not-allowed;"
            >
            <small style="color: #6c757d; margin-top: 5px; display: block; font-size: 0.85em;">
              * A disciplina não pode ser alterada durante a edição.
            </small>
          </ng-container>
        </div>

        <div class="form-group quantidade-group">
          <label>Qtde. Alternativas</label>
          <div class="question-count-selector">
            <span
              [class.active]="quantidadeAlternativas === 4"
              (click)="setQuantidadeAlternativas(4)">4</span>
            <span
              [class.active]="quantidadeAlternativas === 5"
              (click)="setQuantidadeAlternativas(5)">5</span>
          </div>
        </div>
      </div>

      <div class="form-group">
        <label for="enunciado">Questão</label>
        <textarea
          id="enunciado"
          name="enunciado"
          [(ngModel)]="enunciado"
          required
          class="form-control question-textarea"
          rows="5"
          placeholder="Digite o enunciado da questão..."
        ></textarea>
        <div
          *ngIf="questionForm.controls['enunciado']?.invalid && questionForm.controls['enunciado']?.touched"
          class="error-message"
        >
          O texto da questão é obrigatório.
        </div>
      </div>

      <!-- ÁREA DE UPLOAD DE IMAGEM -->
      <div class="form-group">
        <label>Imagem da Questão (Opcional)</label>
        
        <input 
          type="file" 
          #fileInput 
          (change)="onFileSelected($event)" 
          accept="image/*" 
          hidden 
        />

        <!-- Estado 1: Botão de Upload (Quando não tem imagem) -->
        <div 
          *ngIf="!imagePreview" 
          class="upload-box" 
          (click)="fileInput.click()">
          <mat-icon>cloud_upload</mat-icon>
          <span> adicionar imagem </span>
        </div>

        <!-- Estado 2: Preview da Imagem -->
        <div *ngIf="imagePreview" class="preview-box">
          <img [src]="imagePreview" alt="Preview da questão">
          <button 
            type="button" 
            mat-icon-button 
            color="warn" 
            class="remove-btn"
            (click)="removeImage()"
            title="Remover imagem">
            <mat-icon>delete</mat-icon>
          </button>
        </div>
      </div>

      <div class="form-group">
        <label>Alternativas</label>
        <div class="alternativas-list">
          <ng-container *ngFor="let alt of alternativas; let i = index">
            <app-cpt-alternativa-forms
              *ngIf="i < quantidadeAlternativas"
              [alternativa]="alt"
              [index]="i"
              [editavel]="true"
              (selectionRequest)="definirCorreta(i)"
              (textoChange)="onAlternativaChange($event, i)">
            </app-cpt-alternativa-forms>
          </ng-container>
        </div>
      </div>
    </div>

    <div class="action-row">
      <button 
        type="submit" 
        [disabled]="questionForm.invalid || !isAlternativasValidas" 
        class="submit-btn">
        {{ textoBotao }}
      </button>
    </div>
  </form>
</div>