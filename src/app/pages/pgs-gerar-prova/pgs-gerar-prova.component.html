<div class="container">
  <h1>Gerar Avalia√ß√£o (SPA)</h1>

  <!-- PASSO 0: Escolha de Perfil -->
  <div *ngIf="userProfile?.tipo === TipoProfessor.COORDENADOR && currentStepValue === 0" class="step-card fade-in">
    <h2>1. Sele√ß√£o de Perfil</h2>
    <div class="profile-actions">
      <button class="profile-button" (click)="selectProfile(TipoProfessor.PROFESSOR)">
        <span class="icon">üë®‚Äçüè´</span>
        <span>Criar como Professor</span>
        <small>(Apenas minhas disciplinas)</small>
      </button>

      <button class="profile-button" (click)="selectProfile(TipoProfessor.COORDENADOR)">
        <span class="icon">üéì</span>
        <span>Criar como Coordenador</span>
        <small>(Acesso a todas disciplinas)</small>
      </button>
    </div>
  </div>

  <!-- PASSO 1: Sele√ß√£o de Disciplinas e Quantidade Total -->
  <div *ngIf="currentStepValue === 1" class="step-card fade-in">
    <h2>2. Configura√ß√£o da Prova</h2>

    <form [formGroup]="disciplinaForm" (ngSubmit)="nextStep()">

      <!-- SELE√á√ÉO DE DISCIPLINAS -->
      <div class="form-group">
        <label>
          Selecione a(s) disciplina(s):
          <small *ngIf="perfilCriacao === TipoProfessor.PROFESSOR" style="font-weight:normal; color:#666;">(Apenas suas)</small>
          <small *ngIf="perfilCriacao === TipoProfessor.COORDENADOR" style="font-weight:normal; color:#3f51b5;">(Multi-sele√ß√£o com Ctrl)</small>
        </label>

        <select *ngIf="perfilCriacao === TipoProfessor.COORDENADOR"
          class="form-control disciplina-select" multiple size="8"
          (change)="onDisciplinaSelectChange($event)">
          <option *ngFor="let d of disciplinasDisponiveis" [value]="d.id">{{ d.nome }}</option>
        </select>

        <select *ngIf="perfilCriacao === TipoProfessor.PROFESSOR"
          class="form-control disciplina-select"
          (change)="onDisciplinaSelectChange($event)">
          <option value="" disabled selected>Selecione...</option>
          <option *ngFor="let d of disciplinasDisponiveis" [value]="d.id">{{ d.nome }}</option>
        </select>

        <div *ngIf="disciplinaForm.get('disciplinaIds')?.invalid && disciplinaForm.touched" class="error-message">
          ‚ö†Ô∏è Selecione ao menos uma disciplina.
        </div>
      </div>

      <!-- BLOCO √öNICO DE QUANTIDADE (SIMPLIFICADO) -->
      <div *ngIf="selectedDisciplines.length > 0" class="total-block fade-in">
        <div class="total-info">
          <span class="label">Total de quest√µes dispon√≠veis no Banco:</span>
          <span class="value">{{ totalPerguntasDisponiveisNoBanco }}</span>
        </div>

        <div class="form-group" style="margin-bottom: 0;">
          <label for="qtdTotal">Quantas quest√µes deseja na prova?</label>
          <select id="qtdTotal" formControlName="quantidadeTotal" class="form-control">
             <option [ngValue]="null" disabled>Selecione a quantidade...</option>
             <option *ngFor="let n of getRangeTotalAvailable()" [ngValue]="n">{{ n }} Quest√µes</option>
          </select>

          <div *ngIf="disciplinaForm.get('quantidadeTotal')?.invalid && disciplinaForm.touched" class="error-message">
             Defina a quantidade de quest√µes da prova.
          </div>
        </div>
      </div>

      <div class="actions-right">
        <button type="submit" class="btn-primary" [disabled]="disciplinaForm.invalid || disciplinasDisponiveis.length === 0">
          Selecionar Quest√µes &rarr;
        </button>
      </div>
    </form>
  </div>

  <!-- PASSO 2: Sele√ß√£o de Quest√µes (Modo Livre) -->
  <div *ngIf="currentStepValue === 2" class="step-card fade-in">
    <div class="step-header">
      <h2>3. Sele√ß√£o de Quest√µes</h2>
      <div class="stats">
        <span [class.complete]="isSelectionComplete()">
          Selecionadas: <strong>{{ avaliacaoDraft.questoesSelecionadas.length || 0 }}</strong> / {{ quantidadeDesejada }}
        </span>
      </div>
    </div>

    <p class="instruction-text">
      Voc√™ pode selecionar quest√µes livremente de qualquer uma das disciplinas abaixo at√© atingir o total de <strong>{{ quantidadeDesejada }}</strong>.
    </p>

    <div class="question-selection-area">
      <div *ngFor="let d of selectedDisciplines" class="discipline-section">
        <h3 class="discipline-title">
          {{ d.nome }}
          <!-- Mostra quantas foram pegas dessa mat√©ria, meramente informativo -->
          <small>({{ getQuestionsCountForDiscipline(d.id) }} selecionadas)</small>
        </h3>

        <app-cpt-table-materia
          [disciplina]="d"
          [professores]="professores"
          [isSelectionMode]="true"
          [selectedQuestionIds]="selectedQuestionIds"
          [isLimitReached]="isSelectionBlocked()"
          (selectToggle)="toggleQuestao($event)"
        >
        </app-cpt-table-materia>
      </div>
    </div>

    <div class="actions-right">
      <button class="btn-primary" (click)="nextStep()" [disabled]="!isSelectionComplete()">
        Pr√≥xima Etapa (Cabe√ßalho) &rarr;
      </button>
    </div>
  </div>

  <!-- PASSO 3: Cabe√ßalho -->
  <div *ngIf="currentStepValue === 3" class="step-card fade-in">
    <h2>4. Montagem do Cabe√ßalho</h2>
    <form [formGroup]="cabecalhoForm" (ngSubmit)="nextStep()">
      <!-- Mesma estrutura de antes -->
      <div class="form-row">
        <div class="form-group full-width">
          <label>T√≠tulo da Prova</label>
          <input type="text" class="form-control" formControlName="titulo" />
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Turma</label>
          <input type="text" class="form-control" formControlName="turma" />
        </div>
        <div class="form-group">
          <label>Data</label>
          <input type="date" class="form-control" formControlName="data" />
        </div>
      </div>
      <div class="actions-right">
        <button type="submit" class="btn-success" [disabled]="cabecalhoForm.invalid">‚úÖ Gerar PDF</button>
      </div>
    </form>
  </div>

  <!-- Footer -->
  <div class="footer-controls">
    <button class="btn-text-danger" (click)="cancelarProva()">‚úñ Cancelar Prova</button>
    <button *ngIf="currentStepValue > 1" class="btn-text-secondary" (click)="cancelarSelecaoDisciplina()">‚Ü∫ Voltar etapa</button>
  </div>
</div>
