<div class="container">
  <h1>Gerar Avalia√ß√£o (SPA)</h1>

  <div *ngIf="userProfile?.perfilProfessor === TipoProfessor.COORDENADOR && currentStepValue === 0" 
       class="step-card fade-in">
    <h2>1. Sele√ß√£o de Perfil</h2>
    <div class="profile-actions">
      <div class="profile-button" (click)="selectProfile(TipoProfessor.PROFESSOR)">
        <span class="icon">üë®‚Äçüè´</span>
        <span>Criar como Professor</span>
        <small>(Apenas minhas disciplinas)</small>
      </div>
      <div class="profile-button" (click)="selectProfile(TipoProfessor.COORDENADOR)">
        <span class="icon">üéì</span>
        <span>Criar como Coordenador</span>
        <small>(Acesso a todas disciplinas)</small>
      </div>
    </div>
  </div>

  <div *ngIf="currentStepValue === 1" class="step-card fade-in">
    <h2>2. Configura√ß√£o da Prova</h2>
    
    <form [formGroup]="disciplinaForm" (ngSubmit)="nextStep()">
      <div class="form-group">
        <label>
          Selecione a(s) disciplina(s):
          <small *ngIf="perfilCriacao === TipoProfessor.PROFESSOR" style="font-weight:normal; color:#666;">
            (Apenas suas)
          </small>
          <small *ngIf="perfilCriacao === TipoProfessor.COORDENADOR" style="font-weight:normal; color:#3f51b5;">
            (Multi-sele√ß√£o com Ctrl)
          </small>
        </label>
        
        <select *ngIf="perfilCriacao === TipoProfessor.COORDENADOR"
          class="form-control disciplina-select" 
          multiple 
          (change)="onDisciplinaSelectChange($event)">
          <option *ngFor="let d of disciplinasDisponiveis" [value]="d.id">{{ d.nome }}</option>
        </select>

        <select *ngIf="perfilCriacao === TipoProfessor.PROFESSOR"
          class="form-control disciplina-select"
          (change)="onDisciplinaSelectChange($event)">
          <option value="" disabled selected>Selecione...</option>
          <option *ngFor="let d of disciplinasDisponiveis" [value]="d.id">{{ d.nome }}</option>
        </select>
      </div>

      <div *ngIf="selectedDisciplines.length > 0" class="total-block fade-in">
        <div class="total-info">
          <span class="label">Total de quest√µes dispon√≠veis:</span>
          <span class="value">{{ totalPerguntasDisponiveisNoBanco }}</span>
        </div>
        <div class="form-group" style="margin-bottom: 0;">
          <label for="qtdTotal">Quantas quest√µes deseja na prova?</label>
          <select id="qtdTotal" formControlName="quantidadeTotal" class="form-control">
             <option [ngValue]="null" disabled>Selecione a quantidade...</option>
             <option *ngFor="let n of getRangeTotalAvailable()" [ngValue]="n">{{ n }} Quest√µes</option>
          </select>
        </div>
      </div>

      <div class="actions-right">
        <button type="submit" class="btn-primary" 
          [disabled]="disciplinaForm.invalid || disciplinasDisponiveis.length === 0">
          Selecionar Quest√µes &rarr;
        </button>
      </div>
    </form>
  </div>

  <div *ngIf="currentStepValue === 2" class="step-card fade-in">
    <div class="step-header">
      <h2>3. Sele√ß√£o de Quest√µes</h2>
      <div class="stats">
        <!-- CORRE√á√ÉO AQUI: removido o ? antes de .length, pois o array √© obrigat√≥rio se o draft existe -->
        <span [class.complete]="isSelectionComplete()">
          Selecionadas: <strong>{{ avaliacaoDraft?.questoesSelecionadas!.length || 0 }}</strong> / {{ quantidadeDesejada }}
        </span>
      </div>
    </div>
    
    <p class="instruction-text">Selecione at√© atingir o total de <strong>{{ quantidadeDesejada }}</strong> quest√µes.</p>
    
    <div class="question-selection-area">
      <div *ngFor="let d of selectedDisciplines" class="discipline-section">
        <h3 class="discipline-title">
          {{ d.nome }}
          <small>({{ getQuestionsCountForDiscipline(d.id) }} selecionadas)</small>
        </h3>
        <app-cpt-table-materia
          [disciplina]="d"
          [professores]="professores"
          [isSelectionMode]="true"
          [selectedQuestionIds]="selectedQuestionIds"
          [isLimitReached]="isSelectionBlocked()"
          (selectToggle)="toggleQuestao($event)">
        </app-cpt-table-materia>
      </div>
    </div>
    
    <div class="actions-right">
      <button type="button" class="btn-primary" (click)="nextStep()" [disabled]="!isSelectionComplete()">
        Pr√≥xima Etapa (Cabe√ßalho) &rarr;
      </button>
    </div>
  </div>

  <div *ngIf="currentStepValue === 3" class="step-card fade-in">
    <h2>4. Montagem do Cabe√ßalho</h2>
    <p class="instruction-text">Preencha os dados da prova.</p>

    <form [formGroup]="cabecalhoForm" (ngSubmit)="nextStep()">

      <div class="info-fixed">
        <strong>Informa√ß√µes Autom√°ticas:</strong>
        <ul style="margin: 5px 0 0 20px; font-size:0.9rem; color:#555;">
          <li>Institui√ß√£o: FATEC Guarulhos</li>
          <li>Professor: {{ userProfile?.nome || 'Voc√™' }}</li>
          <!-- CORRE√á√ÉO AQUI: TS permite nulo, ent√£o o '?' √© v√°lido agora -->
          <li>Disciplina: {{ perfilCriacao === TipoProfessor.COORDENADOR ? 'Prova Geral' : (avaliacaoDraft?.disciplinaNome || 'Sua Disciplina') }}</li>
        </ul>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Curso *</label>
          <input type="text" class="form-control" formControlName="curso" placeholder="Ex: An√°lise e Desenvolvimento de Sistemas" />
        </div>
        <div class="form-group">
          <label>T√≠tulo da Prova *</label>
          <input type="text" class="form-control" formControlName="titulo" placeholder="Ex: Prova Final - Hist√≥ria" />
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Turma *</label>
          <input type="text" class="form-control" formControlName="turma" placeholder="Ex: ADS-03" />
        </div>
        <div class="form-group">
          <label>Per√≠odo *</label>
          <input type="text" class="form-control" formControlName="periodo" />
        </div>
      </div>

      <div class="form-row" style="grid-template-columns: 1fr 1fr 1fr;">
        <div class="form-group">
          <label>Data da Prova *</label>
          <input type="date" class="form-control" formControlName="data" [min]="minDate" />
        </div>
        <div class="form-group">
          <label>Dura√ß√£o *</label>
          <select class="form-control" formControlName="duracao">
            <option value="" disabled>Selecione...</option>
            <option *ngFor="let opt of durationOptions" [value]="opt">{{ opt }}</option>
          </select>
        </div>
        <div class="form-group">
          <label>Total Pontos *</label>
          <input type="text" class="form-control" formControlName="totalPontos" placeholder="Ex: 10.0" />
        </div>
      </div>

      <div class="actions-right">
        <button type="button" class="btn-text-secondary" (click)="currentStep.next(2)">Voltar</button>
        <button type="submit" class="btn-success" [disabled]="cabecalhoForm.invalid">
          ‚úÖ Gerar PDF
        </button>
      </div>
    </form>
  </div>

  <div class="footer-controls">
    <button type="button" class="btn-text-danger" (click)="cancelarProva()">‚úñ Cancelar Prova</button>
    <button type="button" *ngIf="currentStepValue > 1" class="btn-text-secondary" (click)="cancelarSelecaoDisciplina()">‚Ü∫ Voltar etapa</button>
  </div>
</div>